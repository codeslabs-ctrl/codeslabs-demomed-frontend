<div class="finalizar-consulta-container">
  <!-- Header est√°ndar -->
  <div class="page-header">
    <div class="header-info">
      <h1>
        <i class="fas fa-check-circle"></i>
        Finalizar Consulta
      </h1>
      <div class="consulta-details" *ngIf="consultaInfo">
        <div class="detail-item">
          <strong>Paciente:</strong> {{ consultaInfo.paciente_nombre }}
        </div>
        <div class="detail-item">
          <strong>M√©dico:</strong> {{ consultaInfo.medico_nombre }}
        </div>
        <div class="detail-item">
          <strong>Fecha:</strong> {{ formatDate(consultaInfo.fecha_pautada) }} a las {{ formatTime(consultaInfo.hora_pautada) }}
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-clear" (click)="volverAlDashboard()">
        ‚Üê Volver al Dashboard
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="loading-spinner"></div>
    <p>Cargando informaci√≥n de la consulta...</p>
  </div>

  <!-- Main Content -->
  <div class="main-content" *ngIf="!isLoading">
    <!-- Secci√≥n de Servicios -->
    <div class="servicios-section">
      <div class="section-header">
        <h2>üè• Servicios Ofrecidos</h2>
        <p class="section-description">Seleccione los servicios proporcionados en esta consulta y ajuste los precios seg√∫n corresponda.</p>
      </div>

      <div class="servicios-grid" *ngIf="serviciosDisponibles.length > 0">
        <div class="servicio-card" *ngFor="let servicio of serviciosDisponibles">
          <div class="servicio-header">
            <label class="servicio-checkbox">
              <input
                type="checkbox"
                [checked]="isServicioSeleccionado(servicio.id)"
                (change)="toggleServicio(servicio)"
              />
              <span class="checkmark"></span>
              <div class="servicio-details">
                <div class="servicio-nombre">{{ servicio.nombre_servicio }}</div>
                <div class="servicio-precio">Precio base: ${{ servicio.monto_base | number:'1.2-2' }} {{ servicio.moneda }}</div>
              </div>
            </label>
          </div>
          
          <div class="servicio-form" *ngIf="isServicioSeleccionado(servicio.id)">
            <div class="precio-base-info">
              <small>Precio base: ${{ getServicioSeleccionado(servicio.id).monto_base | number:'1.2-2' }} {{ getServicioSeleccionado(servicio.id).moneda }}</small>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Monto Real Pagado *</label>
                <input
                  type="number"
                  class="form-control"
                  [(ngModel)]="getServicioSeleccionado(servicio.id).monto_pagado"
                  (input)="onMontoInput(servicio.id, $event)"
                  min="0"
                  step="0.01"
                  placeholder="0.00"
                  required
                />
                <small class="form-text text-muted">Puede ser diferente al precio base</small>
              </div>
              <div class="form-group">
                <label>Moneda *</label>
                <select
                  class="form-control"
                  [(ngModel)]="getServicioSeleccionado(servicio.id).moneda"
                  (change)="onMonedaChange(servicio.id, $event)"
                  required
                >
                  <option value="VES">Bol√≠vares (VES)</option>
                  <option value="USD">D√≥lares (USD)</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Observaciones</label>
              <textarea
                class="form-control"
                [(ngModel)]="getServicioSeleccionado(servicio.id).observaciones"
                (input)="onObservacionesInput(servicio.id, $event)"
                placeholder="Observaciones adicionales (opcional)..."
                rows="2"
              ></textarea>
            </div>
          </div>
        </div>
      </div>
      
      <div class="no-servicios-info" *ngIf="serviciosDisponibles.length === 1 && serviciosDisponibles[0].id === -1">
        <div class="info-message">
          <i class="fas fa-info-circle"></i>
          <span>No se encontraron servicios configurados para esta especialidad. Se ha creado autom√°ticamente un servicio predeterminado "Consulta".</span>
        </div>
      </div>
    </div>

    <!-- Resumen de Servicios Seleccionados -->
    <div class="resumen-section" *ngIf="serviciosSeleccionados.length > 0">
      <h3>üìã Resumen de Servicios Seleccionados</h3>
      <div class="resumen-table">
        <div class="resumen-header">
          <div>Servicio</div>
          <div>Monto</div>
          <div>Moneda</div>
          <div>Acciones</div>
        </div>
        <div class="resumen-row" *ngFor="let servicio of serviciosSeleccionados">
          <div class="servicio-nombre">{{ servicio.servicio_nombre }}</div>
          <div class="monto">${{ servicio.monto_pagado | number:'1.2-2' }}</div>
          <div class="moneda">{{ servicio.moneda }}</div>
          <div class="acciones">
            <button 
              class="btn-remove" 
              (click)="removeServicio(servicio.servicio_id)"
              title="Quitar servicio">
              ‚ùå
            </button>
          </div>
        </div>
      </div>
      
      <div class="totales">
        <div class="total-ves" *ngIf="totalVES > 0">
          <strong>Total VES: ${{ totalVES | number:'1.2-2' }}</strong>
        </div>
        <div class="total-usd" *ngIf="totalUSD > 0">
          <strong>Total USD: ${{ totalUSD | number:'1.2-2' }}</strong>
        </div>
        <div class="total-general" *ngIf="totalVES > 0 || totalUSD > 0">
          <strong>Total General: ${{ (totalVES + totalUSD) | number:'1.2-2' }}</strong>
        </div>
      </div>
    </div>


    <!-- Botones de Acci√≥n -->
    <div class="action-buttons">
      <button 
        class="btn btn-clear" 
        (click)="volverAlDashboard()"
        [disabled]="isSubmitting">
        Cancelar
      </button>
      <button 
        class="btn btn-new" 
        (click)="finalizarConsulta()"
        [disabled]="!canFinalizar() || isSubmitting"
        [title]="!tieneServiciosDisponibles() ? 'Finalizar sin servicios (solo con diagn√≥stico)' : ''">
        <span *ngIf="isSubmitting" class="spinner"></span>
        {{ isSubmitting ? 'Finalizando...' : 'Finalizar Consulta' }}
        <span *ngIf="!tieneServiciosDisponibles() && !isSubmitting" class="warning-badge">‚ö†Ô∏è</span>
      </button>
    </div>
  </div>
</div>
