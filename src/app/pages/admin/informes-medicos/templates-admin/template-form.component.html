<div class="template-form-page">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1>
        <i class="fas fa-file-medical"></i>
        {{ esEdicion ? 'Editar Plantilla' : 'Nueva Plantilla' }}
      </h1>
      <p class="page-description">
        {{ esEdicion ? 'Modificar plantilla existente' : 'Crear una nueva plantilla de informe médico' }}
      </p>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="volver()">
        ← Volver a Plantillas
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Cargando datos de la plantilla...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="alert alert-danger">
    <i class="fas fa-exclamation-triangle"></i>
    {{ error }}
  </div>

  <!-- Formulario -->
  <form class="form-container" [formGroup]="templateForm" (ngSubmit)="guardarTemplate()" *ngIf="!loading">
    <!-- Información Básica -->
    <div class="form-section">
      <div class="section-header">
        <h3>
          <i class="fas fa-info-circle"></i>
          Información Básica
        </h3>
      </div>
      <div class="section-content">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-tag"></i> Nombre de la Plantilla *
            </label>
            <input 
              type="text" 
              class="form-input" 
              formControlName="nombre"
              placeholder="Ej: Informe de Consulta General">
            <div class="form-group-footer">
              <div *ngIf="nombre?.invalid && nombre?.touched" class="error-message">
                {{ obtenerErrorCampo('nombre') }}
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-file-alt"></i> Tipo de Informe *
            </label>
            <select class="form-input" formControlName="tipo_informe">
              <option value="">Seleccionar tipo</option>
              <option *ngFor="let tipo of tiposInforme" [value]="tipo.valor">
                {{ tipo.texto }}
              </option>
            </select>
            <div class="form-group-footer">
              <div *ngIf="tipo_informe?.invalid && tipo_informe?.touched" class="error-message">
                {{ obtenerErrorCampo('tipo_informe') }}
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-user-md"></i> Especialidad
            </label>
            <select class="form-input" formControlName="especialidad_id">
              <option value="">Sin especialidad específica</option>
              <option *ngFor="let especialidad of especialidades" [value]="especialidad.id">
                {{ especialidad.nombre_especialidad }}
              </option>
            </select>
            <div class="help-text">Opcional: Asignar a una especialidad específica</div>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-toggle-on"></i> Estado
            </label>
            <select class="form-input" formControlName="activo">
              <option [value]="'true'">Activa</option>
              <option [value]="'false'">Inactiva</option>
            </select>
            <div class="help-text">Las plantillas inactivas no aparecerán en el selector</div>
          </div>
        </div>

        <div class="form-group full-width">
          <label class="form-label">
            <i class="fas fa-align-left"></i> Descripción
          </label>
          <textarea 
            class="form-textarea" 
            formControlName="descripcion"
            placeholder="Describe el propósito y uso de esta plantilla..."
            rows="3"></textarea>
          <div class="form-group-footer">
            <div *ngIf="descripcion?.invalid && descripcion?.touched" class="error-message">
              {{ obtenerErrorCampo('descripcion') }}
            </div>
            <div class="help-text">Opcional: Descripción de cuándo usar esta plantilla</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido de la Plantilla -->
    <div class="form-section">
      <div class="section-header">
        <h3>
          <i class="fas fa-file-text"></i>
          Contenido de la Plantilla
        </h3>
        <div class="section-description">
          <p>Escribe el contenido HTML de la plantilla. Puedes usar variables como <code>{{ '{' }}nombre_paciente{{ '}' }}</code>, <code>{{ '{' }}fecha_consulta{{ '}' }}</code>, etc.</p>
        </div>
      </div>
      <div class="section-content">
        <div class="form-group full-width">
          <label class="form-label">
            <i class="fas fa-edit"></i> Contenido HTML *
          </label>
          <app-rich-text-editor
            [value]="contenidoValue"
            (valueChange)="onContenidoChange($event)"
            [height]="400"
            [placeholder]="'Escriba el contenido de la plantilla aquí... Puede usar variables como {nombre_paciente}, {fecha_consulta}, {motivo_consulta}, etc.'">
          </app-rich-text-editor>
          <div class="form-group-footer">
            <div *ngIf="contenido_template?.invalid && contenido_template?.touched" class="error-message">
              {{ obtenerErrorCampo('contenido_template') }}
            </div>
            <div class="help-text">
              <strong>Variables disponibles:</strong> {{ '{' }}nombre_paciente{{ '}' }}, {{ '{' }}fecha_consulta{{ '}' }}, {{ '{' }}motivo_consulta{{ '}' }}, {{ '{' }}examen_fisico{{ '}' }}, {{ '{' }}diagnostico{{ '}' }}, {{ '{' }}tratamiento{{ '}' }}, {{ '{' }}recomendaciones{{ '}' }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Botones de Acción -->
    <div class="form-actions">
      <div class="action-buttons">
        <button type="button" class="btn btn-clear" (click)="previsualizar()">
          <i class="fas fa-eye"></i> Vista Previa
        </button>
        
        <button type="submit" class="btn btn-primary" [disabled]="saving || templateForm.invalid">
          <i class="fas fa-save" *ngIf="!saving"></i>
          <span class="spinner" *ngIf="saving"></span>
          {{ saving ? 'Guardando...' : (esEdicion ? 'Actualizar Plantilla' : 'Crear Plantilla') }}
        </button>
      </div>
    </div>
  </form>
</div>